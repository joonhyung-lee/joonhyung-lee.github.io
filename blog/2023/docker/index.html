<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <blockquote> <p>기타 유용한 <code class="language-plaintext highlighter-rouge">Docker</code> 명령어에 대해 작성합니다.</p> </blockquote> <h3 id="make-dockerfile">Make Dockerfile</h3> <ul> <li>Get docker image <ul> <li><code class="language-plaintext highlighter-rouge">docker pull nvidia/cuda:11.6.1-devel-ubuntu20.04</code></li> </ul> </li> <li>Dockerfile <ul> <li><strong>반드시 파일의 제목은 <code class="language-plaintext highlighter-rouge">Dockerfile</code> 이어야 한다. (확장자는 없음.)</strong></li> </ul> </li> </ul> <h4 id="example-dockerfile">Example <strong>Dockerfile</strong> </h4> <div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 기존 이미지를 기반으로 사용</span>
<span class="c"># Use nvidia/cuda version matches your server</span>
<span class="k">FROM</span><span class="s"> nvidia/cuda:11.6.1-cudnn8-devel-ubuntu20.04</span>

<span class="c"># 필요한 패키지 설치</span>
<span class="c"># Install ubuntu apt packages. Do not remove default packages.</span>
<span class="k">RUN </span>apt-get update
<span class="c"># opencv-python error</span>
<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get <span class="nb">install</span><span class="se">\
</span>    libgl1<span class="se">\
</span>    libgl1-mesa-glx <span class="se">\ </span>
    libglib2.0-0 -y &amp;&amp; \
    rm -rf /var/lib/apt/lists/*
<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\
</span>    wget <span class="se">\
</span>    apt-utils <span class="se">\
</span>    build-essential <span class="se">\
</span>    ca-certificates <span class="se">\
</span>    curl <span class="se">\
</span>    git <span class="se">\
</span>    htop <span class="se">\
</span>    <span class="nb">sudo</span> <span class="se">\
</span>    vim <span class="se">\
</span>    python3-dev <span class="se">\
</span>    python3-pip <span class="se">\
</span>    <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

<span class="c"># Miniconda 설치</span>
<span class="k">RUN </span>wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh <span class="nt">-O</span> /miniconda.sh
<span class="k">RUN </span>bash /miniconda.sh <span class="nt">-b</span> <span class="nt">-p</span> /miniconda
<span class="k">ENV</span><span class="s"> PATH="/miniconda/bin:${PATH}"</span>

<span class="c"># Conda를 이용해 Python3 설치 및 Python 패키지 설치</span>
<span class="k">RUN </span>conda <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">python</span><span class="o">=</span>3.9 <span class="o">&amp;&amp;</span> <span class="se">\
</span>    pip3 <span class="nt">--no-cache-dir</span> <span class="nb">install</span> <span class="nt">--upgrade</span> <span class="se">\
</span>    pip <span class="se">\
</span>    setuptools <span class="se">\
</span>    ipython <span class="se">\
</span>    ipdb <span class="se">\
</span>    matplotlib <span class="se">\
</span>    pandas <span class="se">\
</span>    scipy <span class="se">\
</span>    torch <span class="se">\
</span>    jupyter <span class="se">\
</span>    torchvision <span class="se">\
</span>    torchtext <span class="se">\
</span>    torchsummary <span class="se">\
</span>    slacker <span class="se">\
</span>    tqdm

<span class="c"># # 사용자 설정</span>
<span class="c"># ARG UNAME</span>
<span class="c"># ARG UID</span>
<span class="c"># ARG GID</span>

<span class="c"># # Ensure that the group and user are created successfully</span>
<span class="c"># RUN if [ -z "$UNAME" ] || [ -z "$UID" ] || [ -z "$GID" ]; then echo "UNAME, UID, and GID arguments are required" &amp;&amp; exit 1; fi &amp;&amp; \</span>
<span class="c">#     addgroup --gid ${GID} ${UNAME} &amp;&amp; \</span>
<span class="c">#     useradd -m -u ${UID} -g ${GID} -s /bin/bash ${UNAME} &amp;&amp; \</span>
<span class="c">#     adduser ${UNAME} sudo</span>

<span class="c"># USER ${UNAME}</span>
<span class="c"># WORKDIR /home/${UNAME}</span>

<span class="k">CMD</span><span class="s"> [ "/bin/bash" ]</span>
</code></pre></div></div> <details> <summary>Build Log</summary> <div> <div class="language-docker highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>joonhyung@devbox:~/dockers/joonh_cu116$ docker build -t joonh_cu116 .
[+] Building 260.0s (11/11) FINISHED                                                                                                                                                    
 =&gt; [internal] load .dockerignore                                                                                                                                                  0.0s
 =&gt; =&gt; transferring context: 2B                                                                                                                                                    0.0s
 =&gt; [internal] load build definition from Dockerfile                                                                                                                               0.0s
 =&gt; =&gt; transferring dockerfile: 1.72kB                                                                                                                                             0.0s
 =&gt; [internal] load metadata for docker.io/nvidia/cuda:11.6.1-cudnn8-devel-ubuntu20.04                                                                                             0.0s
 =&gt; [1/7] FROM docker.io/nvidia/cuda:11.6.1-cudnn8-devel-ubuntu20.04                                                                                                               0.0s
 =&gt; CACHED [2/7] RUN apt-get update                                                                                                                                                0.0s
 =&gt; [3/7] RUN apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install    libgl1    libgl1-mesa-glx     libglib2.0-0 -y &amp;&amp;     rm -rf /var/lib/apt/lists/*                19.2s
 =&gt; [4/7] RUN apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y     wget     apt-utils     build-essential     ca-certificates     curl     git     htop     s  24.1s
 =&gt; [5/7] RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /miniconda.sh                                                                          3.0s
 =&gt; [6/7] RUN bash /miniconda.sh -b -p /miniconda                                                                                                                                  6.4s
 =&gt; [7/7] RUN conda install -y python=3.9 &amp;&amp;     pip3 --no-cache-dir install --upgrade     pip     setuptools     ipython     ipdb     matplotlib     pandas     scipy     torc  177.4s
 =&gt; exporting to image                                                                                                                                                            29.8s
 =&gt; =&gt; exporting layers                                                                                                                                                           29.8s
 =&gt; =&gt; writing image sha256:48e3f2be75424e71be48c75d5472c90a9bf5ac9c94586bd723127d5bed67714b                                                                                       0.0s 
 =&gt; =&gt; naming to docker.io/library/joonh_cu116
</code></pre></div> </div> </div> </details> <h4 id="build-docker-image">Build docker image</h4> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> <span class="o">[</span>이미지 이름:이미지 버전] <span class="o">[</span>Dockerfile의 경로]
docker build <span class="nt">-t</span> joonh_cu116 <span class="nb">.</span>
docker build <span class="nt">--build-arg</span> <span class="nv">UNAME</span><span class="o">=</span>joonhyung-lee <span class="nt">--build-arg</span> <span class="nv">UID</span><span class="o">=</span>1001 <span class="nt">--build-arg</span> <span class="nv">GID</span><span class="o">=</span>1001 <span class="nt">-t</span> joonh_cu116 <span class="nb">.</span>
</code></pre></div></div> <h4 id="get-built-docker-images">Get built docker images</h4> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker images
<span class="o">&gt;&gt;&gt;</span> joonh_cu116    latest    7c1bae5ab933   33 seconds ago   9.56GB
</code></pre></div></div> <h4 id="start-docker-container">Start Docker Container</h4> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-v</span> <span class="o">[</span>로컬_경로]:[컨테이너_경로] <span class="nt">-it</span> <span class="nt">--gpus</span> all <span class="o">[</span>이미지_이름]:[태그] /bin/bash
docker run <span class="nt">-v</span> /home/joonhyung/python/:/home/root/python <span class="nt">-it</span> <span class="nt">--gpus</span> all joonh_cu116:latest /bin/bash
</code></pre></div></div> <h2 id="commit-and-push-docker-container">Commit and Push Docker Container</h2> <h3 id="get-information-about-container">get information about container</h3> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>joonhyung@devbox:~/dockers/joonh_cu116<span class="nv">$ </span>docker ps
CONTAINER ID   IMAGE                              COMMAND                  CREATED             STATUS             PORTS                                       NAMES
79b602e29923   c2e91d98d3ed                       <span class="s2">"/opt/nvidia/nvidia_…"</span>   About an hour ago   Up About an hour                                               magical_neumann
</code></pre></div></div> <h3 id="commit">Commit</h3> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker commit CONTAINER IMAGE_NAME
joonhyung@devbox:~/dockers/joonh_cu116<span class="nv">$ </span>docker commit 79b602e29923 joonh_cu116:v00
sha256:f50aabee25697dc96bc80f76fd231c74d1fbfe77cb47698a4ec89e0b84c5ba81
</code></pre></div></div> <ul> <li>docker images로 image가 적절하게 생성되었는지 확인 가능.</li> </ul> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  joonhyung@devbox:~/dockers/joonh_cu116<span class="nv">$ </span>docker images
  REPOSITORY                                                  TAG                               IMAGE ID       CREATED          SIZE
  joonh_cu116                                                 v00                               f50aabee2569   14 seconds ago   31GB
</code></pre></div></div> <h3 id="build-dockerfile">Build <strong><code class="language-plaintext highlighter-rouge">Dockerfile</code></strong> </h3> <ul> <li>Add lines <ul> <li> <div class="language-shell highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>FROM joonh_cu116:v00
<span class="c"># Install ubuntu apt packages.</span>
RUN <span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> &lt;ubuntu-packages&gt;
</code></pre></div> </div> </li> </ul> </li> <li>Build New version <ul> <li> <div class="language-shell highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> joonh_cu116:v01 <span class="nb">.</span>
</code></pre></div> </div> </li> </ul> </li> </ul> <h3 id="login-docker-server">Login Docker server</h3> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  joonhyung@devbox:~/dockers/joonh_cu116_v00<span class="nv">$ </span>docker login <span class="nt">-u</span> joonhyunglee
  Password: 
  WARNING! Your password will be stored unencrypted <span class="k">in</span> /home/joonhyung/.docker/config.json.
  Configure a credential helper to remove this warning. See
  https://docs.docker.com/engine/reference/commandline/login/#credentials-store

  Login Succeeded
</code></pre></div></div> <h3 id="push-on-docker">push on Docker</h3> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>joonhyung@devbox:~/dockers/joonh_cu116_v00<span class="nv">$ </span>docker push joonhyunglee/joonh_cu116:v01
</code></pre></div></div> </body></html>